<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OSRS Herblore — Live GP/XP (cleaned)</title>
<style>
  :root{ --bg:#0b0f14; --panel:#111827; --ink:#e5e7eb; --muted:#9ca3af; --accent:#60a5fa; --ok:#10b981; --bad:#ef4444 }
  html,body{height:100%}
  body{margin:0; background:linear-gradient(180deg,var(--bg),#0f172a); color:var(--ink); font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif}
  header{padding:18px 20px; position:sticky; top:0; z-index:5; backdrop-filter:saturate(140%) blur(6px); background:linear-gradient(180deg,rgba(15,23,42,.9),rgba(15,23,42,.65))}
  h1{margin:0 0 6px; font-size:20px; font-weight:700}
  .sub{color:var(--muted); font-size:12px}
  main{max-width:1220px; margin:16px auto 64px; padding:0 16px}
  .card{background:var(--panel); border:1px solid #1f2937; border-radius:16px; box-shadow:0 8px 24px rgba(0,0,0,.25); overflow:hidden}
  .card .hd{display:flex; gap:12px; flex-wrap:wrap; align-items:center; padding:14px 16px; border-bottom:1px solid #1f2937}
  .controls{display:grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap:10px; padding:12px 16px}
  label{display:flex; align-items:center; gap:8px; color:var(--muted)}
  select,input[type="checkbox"],input[type="number"],textarea{background:#0b1220; color:var(--ink); border:1px solid #223047; border-radius:10px; padding:8px 10px; width:100%}
  .grid{display:grid; grid-template-columns:1fr; gap:16px}
  .btn{appearance:none; border:1px solid #2b3a55; background:#0d1423; color:var(--ink); padding:8px 12px; border-radius:10px; cursor:pointer}
  .btn:hover{border-color:#3f567e}
  button:disabled{opacity:.6; cursor:not-allowed}
  .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; background:#0d1423; border:1px solid #26344f; font-size:12px; color:var(--muted)}
  .right{margin-left:auto}
  .tablewrap{overflow:auto; max-height:70vh}
  table{border-collapse:separate; border-spacing:0; width:100%; font-variant-numeric:tabular-nums}
  th,td{padding:10px 12px; border-bottom:1px solid #1f2937; white-space:nowrap; vertical-align:middle}
  th{position:sticky; top:0; background:#0e1627; text-align:left; font-weight:600; z-index:3; cursor:pointer}
  tr:hover{background:#0c1424}
  .num{text-align:right}
  .ok{color:var(--ok)} .bad{color:var(--bad)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
  .foot{color:var(--muted); font-size:12px; padding:10px 16px}
  .hint{color:var(--muted); font-size:12px}

  /* Main table: let Notes wrap and visually separate it */
  #tbl td:last-child, #tbl th:last-child{ border-left:1px solid #26344f; }
  .notes{ white-space:normal; overflow-wrap:anywhere; line-height:1.35 }

  /* Row details block */
  tr.detail td{ padding:0; background:#0a1120; }
  .expand{ padding:12px 16px; border-top:1px solid #15223a; }
  .expand h4{ margin:0 0 8px; font-size:14px; font-weight:700 }
  .expand .meta{ color:var(--muted); font-size:12px; margin-bottom:8px }
  .expand table{ width:100%; border-collapse:separate; border-spacing:0; }
  .expand th, .expand td{ border-bottom:1px solid #16223a; padding:8px 10px; white-space:nowrap; vertical-align:top }
  .expand th + th, .expand td + td{ border-left:1px solid #16223a; }
  .expand .num{ padding-right:14px; }
  .expand th{ background:#0c1629; position:static; cursor:default }
  .expand a{ color:var(--accent); text-decoration:none }
  .expand a:hover{ text-decoration:underline }
  .expand td:last-child{ white-space:normal; overflow-wrap:anywhere; }
  .kbd{ font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; padding:1px 6px; border:1px solid #2b3a55; border-radius:6px; background:#0d1423; color:var(--muted); font-size:11px }
  .rowclick{ cursor:pointer }

  /* Refresh-now layout */
  .autorefresh .row{ display:flex; align-items:center; gap:8px; width:100% }
  .autorefresh input{ flex:1 }
</style>
</head>
<body>
<header>
  <h1>OSRS Herblore — Live GP/XP</h1>
  <div class="sub">Uses <span class="pill">prices.runescape.wiki</span> live data. Per‑dose valuation from the (4) item. Amulet +15% expected dose (cap 4). Goggles 10% save on secondaries (excl. crystal dust). ECTS pricing option for dust.</div>
</header>

<main class="grid">
  <section class="card">
    <div class="hd">
      <strong>Options</strong>
      <span id="status" class="pill">Loading mapping…</span>
      <span id="lastUpdate" class="pill right">—</span>
    </div>
    <div class="controls">
      <label>Buy price basis
        <select id="buyBasis">
          <option value="mid">Mid ((high+low)/2)</option>
          <option value="high">Instant Buy (avgHigh)</option>
          <option value="low">Low (avgLow)</option>
        </select>
      </label>
      <label>Sell price basis
        <select id="sellBasis">
          <option value="mid">Mid ((high+low)/2)</option>
          <option value="low">Instant Sell (avgLow)</option>
          <option value="high">High (avgHigh)</option>
        </select>
      </label>
      <label>GE tax on sale (2%)
        <input id="tax" type="checkbox" checked>
      </label>
      <label>Crystal dust pricing
        <select id="dustMode">
          <option value="ects">From Enhanced crystal teleport seed → 150 shards → 10 dust/shard</option>
          <option value="market">Direct (Crystal dust)</option>
        </select>
      </label>
      <label class="autorefresh">Auto-refresh (min)
        <div class="row">
          <input id="refreshMins" type="number" min="0" step="1" value="10" />
          <button class="btn" id="refreshNow" type="button" title="Fetch latest and recompute">Refresh now</button>
        </div>
      </label>
    </div>
  </section>

  <section class="card">
    <div class="hd">
      <strong>Results (valued using 4-dose prices per dose)</strong>
      <div class="right" style="display:flex; gap:8px">
        <button class="btn" id="copyCsv">Copy CSV</button>
        <button class="btn" id="downloadCsv">Download CSV</button>
      </div>
    </div>
    <div class="tablewrap">
      <table id="tbl">
        <thead>
          <tr>
            <th data-k="name">Potion</th>
            <th data-k="xp" class="num">XP</th>
            <th data-k="baseDoses" class="num">Base doses</th>
            <th data-k="expDoses" class="num">Expected doses</th>
            <th data-k="cost" class="num">Buy cost</th>
            <th data-k="revenue" class="num">Sell value</th>
            <th data-k="profit" class="num">GP / potion</th>
            <th data-k="profitPct" class="num">Profit %</th>
            <th data-k="gpxp" class="num">GP / XP</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="foot">Mechanics: Amulet adds 0.15 expected dose when base&lt;4 (cap 4). Goggles save 10% of secondaries (excl. dust). All potion prices per‑dose from the (4) item. ECTS option for dust.</div>
  </section>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt = n => (n==null || Number.isNaN(n))? '—' : n.toLocaleString();
  const pct = n => (n==null || Number.isNaN(n))? '—' : ((n>=0?'+':'') + n.toFixed(1) + '%');
  const n2 = n => (n==null || Number.isNaN(n))? null : +n;
  const HEADERS = {'Accept':'application/json','Api-User-Agent':'HerbLive/2.1 (single-file browser app)'};

  const els = {
    status: $('#status'), lastUpdate: $('#lastUpdate'),
    buyBasis: $('#buyBasis'), sellBasis: $('#sellBasis'), tax: $('#tax'), dustMode: $('#dustMode'), refreshMins: $('#refreshMins'),
    tbody: $('#tbody'), tbl: $('#tbl'), copyCsv: $('#copyCsv'), downloadCsv: $('#downloadCsv'),
    refreshNow: $('#refreshNow')
  };

  function parseDoseSuffix(name){ const m = String(name).trim().match(/\((\d)\)$/); return m? Number(m[1]) : null; }
  const isPotionName = (name)=> /\(\d\)$/.test(name);
  const isUnf = (name)=> /\(unf\)/i.test(name);
  const esc = (s)=> String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

  let MAP=null, PRICE=null;
  async function fetchMapping(){
    els.status.textContent='Loading mapping…';
    const r=await fetch('https://prices.runescape.wiki/api/v1/osrs/mapping',{headers:HEADERS});
    if(!r.ok) throw new Error('mapping '+r.status);
    const arr=await r.json(); const map=new Map(); for(const it of arr){ map.set(it.name.toLowerCase(), it); }
    MAP=map; els.status.textContent='Mapping ready ('+arr.length+' items)';
  }
  async function fetchLatest(){
    els.status.textContent='Fetching latest…';
    const r=await fetch('https://prices.runescape.wiki/api/v1/osrs/latest',{headers:HEADERS});
    if(!r.ok) throw new Error('latest '+r.status);
    const j=await r.json(); PRICE=j.data; els.lastUpdate.textContent='Updated '+new Date().toLocaleTimeString(); els.status.textContent='Prices ready';
  }
  function findItem(name){ return MAP?.get(String(name).trim().toLowerCase()) || null; }
  function priceFor(nameOrId){
    if(!PRICE) return null; let id=null;
    if(typeof nameOrId==='number' || /^\d+$/.test(String(nameOrId))){ id=String(nameOrId); }
    else { const it=findItem(nameOrId); if(!it) return null; id=String(it.id); }
    const p=PRICE[id]; if(!p) return null; return {id,high:n2(p.high),low:n2(p.low)};
  }
  function basisVal(p,basis){ if(!p) return null; if(basis==='high') return n2(p.high); if(basis==='low') return n2(p.low); return (p.high!=null&&p.low!=null)? (p.high+p.low)/2 : (p.high ?? p.low ?? null); }
  function basisLabel(b){ return b==='high'? 'High' : b==='low'? 'Low' : 'Mid'; }

  function perDoseFrom4(itemName, basis){
    const d=parseDoseSuffix(itemName);
    if(d==null){ const p=priceFor(itemName); return basisVal(p, basis); }
    const base=itemName.replace(/\((\d)\)$/,'(4)');
    const p4=priceFor(base); const v4=basisVal(p4, basis);
    return v4!=null? (v4/4) : null;
  }

  function dustUnitFromECTS(basis){
    const ects=priceFor('Enhanced crystal teleport seed'); const v=basisVal(ects, basis);
    return v==null? null : v/(150*10); // 150 shards per seed; 10 dust per shard
  }

  function isSecondary(name){ return !(isPotionName(name) || isUnf(name)); }
  const pricesUrl = (id)=> id? `https://prices.runescape.wiki/osrs/item/${id}` : null;

  function computeRow(rec){
    const buyB=els.buyBasis.value, sellB=els.sellBasis.value, tax=els.tax.checked? 0.02 : 0;
    const baseD=rec.baseDoses||3; const expD=Math.min(4, baseD + 0.15);

    let cost=0; const missing=[]; const parts=[];
    for(const raw of rec.components){
      const c = (typeof raw==='string')? {name:raw.trim(), qty:1} : {...raw};
      const nm = c.name;
      let unit=null, via4=false, viaECTS=false, id=null;

      if(/crystal\s*dust/i.test(nm)){
        if(els.dustMode.value==='ects'){ unit = dustUnitFromECTS(buyB); viaECTS=true; }
        else { const pd=priceFor('Crystal dust'); unit=basisVal(pd,buyB); }
        const it=findItem('Crystal dust'); id=it?.id ?? null;
      } else if(isPotionName(nm)){
        const perDose=perDoseFrom4(nm, buyB); via4=true; unit=perDose; // per dose
        const it4=findItem(nm.replace(/\((\d)\)$/,'(4)')) || findItem(nm);
        id=it4?.id ?? null;
      } else {
        const p=priceFor(nm); unit=basisVal(p,buyB); id=findItem(nm)?.id ?? null;
      }

      const isSec = isSecondary(nm);
      const save = (isSec && !/crystal\s*dust/i.test(nm))? 0.10 : 0;
      const qtyBase = isPotionName(nm) ? (parseDoseSuffix(nm) || 1) : (c.qty ?? 1);
      const effQty = qtyBase * (1 - save);
      const total = unit==null? null : unit * effQty;
      if(unit==null) missing.push(nm);
      cost += total ?? 0;

      parts.push({ name:nm, id, url:pricesUrl(id), qty:qtyBase, effQty, unit, total, basis:buyB, via4, viaECTS, isSecondary:isSec, saved:save });
    }

    const p4=priceFor(rec.product4); const v4=basisVal(p4, sellB);
    const perDoseSell = v4!=null? (v4/4) : null;
    const gross = perDoseSell!=null? (perDoseSell * expD) : null;
    const revenue = gross!=null? gross * (1 - tax) : null;

    const profit = (revenue!=null && cost!=null)? (revenue - cost) : null;
    const gpxp = (rec.xp>0 && profit!=null)? (profit/rec.xp) : null;
    const profitPct = (profit!=null && cost>0)? (profit/cost*100) : null;

    const noteBits=[];
    if(perDoseSell==null) noteBits.push(`Missing price: ${rec.product4}`);
    if(missing.length) noteBits.push(`Missing price: ${missing.join(', ')}`);
    noteBits.push(`Sell using (4) per‑dose`);

    const prodItem = findItem(rec.product4);
    const out = { productName: rec.product4, id: prodItem?.id ?? null, url: pricesUrl(prodItem?.id ?? null), perDoseSell, expDoses:expD, gross, net:revenue, taxRate:tax, basis:sellB };

    return {name:rec.name, xp:rec.xp, baseDoses:baseD, expDoses:expD, cost, revenue, profit, profitPct, gpxp, note:noteBits.join(' · '), parts, out};
  }

  function rowDetailHTML(r){
    const out=r.out;
    const head = `Output: ${out.url? `<a href="${out.url}" target="_blank" rel="noopener">${esc(out.productName)}</a>` : esc(out.productName)} — per‑dose sell (${basisLabel(out.basis)}) <span class="mono">${fmt(Math.round(out.perDoseSell??0))}</span> × expected doses <span class="mono">${out.expDoses.toFixed(2)}</span> → gross <span class="mono">${fmt(Math.round(out.gross??0))}</span>${out.taxRate? `, after ${Math.round(out.taxRate*100)}% tax <span class=mono>${fmt(Math.round(out.net??0))}</span>`:''}`;

    const rows = r.parts.map(p=>{
      const notes = [p.via4? 'per‑dose from (4)':'' , p.viaECTS? 'via ECTS':'' , (p.saved>0? 'goggles −10% save':'')].filter(Boolean).join('; ');
      const name = p.url? `<a href="${p.url}" target="_blank" rel="noopener">${esc(p.name)}</a>` : esc(p.name);
      return `<tr>
        <td>${name}</td>
        <td class="num mono">${fmt(p.qty)}</td>
        <td class="num mono">${fmt(p.effQty.toFixed(3))}</td>
        <td class="num mono">${fmt(Math.round(p.unit??0))}</td>
        <td class="num mono">${fmt(Math.round(p.total??0))}</td>
        <td class="hint">${esc(notes)}</td>
      </tr>`;
    }).join('');

    return `<div class="expand">
      <h4>${esc(r.name)}</h4>
      <div class="meta">${head}</div>
      <div class="hint" style="margin-bottom:6px">Component costs use <span class="kbd">${basisLabel(els.buyBasis.value)}</span> for buy basis. Potion components are valued at <b>(4) per‑dose</b>. Goggles apply −10% expected quantity to secondaries (except Crystal dust). Crystal dust can be valued from ECTS depending on the selector.</div>
      <table>
        <thead>
          <tr><th>Component</th><th class="num">Qty</th><th class="num">Eff. Qty</th><th class="num">Unit gp</th><th class="num">Total gp</th><th>Notes</th></tr>
        </thead>
        <tbody>${rows}</tbody>
      </table>
    </div>`;
  }

  function renderRows(rows){
    const tb=els.tbody; tb.innerHTML='';
    const COLS = document.querySelectorAll('#tbl thead th').length;
    for(const r of rows){
      const tr=document.createElement('tr'); tr.className='rowclick'; tr.dataset.key=r.name;
      const cls=r.profit==null? '' : (r.profit>=0? 'ok':'bad');
      tr.innerHTML=`
        <td>${esc(r.name)}</td>
        <td class="num">${fmt(r.xp)}</td>
        <td class="num">${fmt(r.baseDoses)}</td>
        <td class="num">${fmt(r.expDoses.toFixed(2))}</td>
        <td class="num mono">${fmt(Math.round(r.cost??0))}</td>
        <td class="num mono">${fmt(Math.round(r.revenue??0))}</td>
        <td class="num mono ${cls}">${r.profit==null? '—' : fmt(Math.round(r.profit))}</td>
        <td class="num mono ${cls}">${pct(r.profitPct)}</td>
        <td class="num mono ${cls}">${r.gpxp==null? '—' : ( (r.gpxp>=0? '+':'') + r.gpxp.toFixed(3) )}</td>
        <td class="hint notes">${esc(r.note)}</td>`;

      const det=document.createElement('tr'); det.className='detail'; det.style.display='none';
      const td=document.createElement('td'); td.colSpan=COLS; td.innerHTML=rowDetailHTML(r); det.appendChild(td);

      tr.addEventListener('click', (ev)=>{
        if(ev.target.closest('a') || ev.target.closest('button')) return; // don't toggle when clicking links/buttons
        det.style.display = det.style.display==='none'? 'table-row' : 'none';
      });

      tb.appendChild(tr); tb.appendChild(det);
    }
  }

  function toCsv(rows){
    const hdr=['Potion','XP','Base doses','Expected doses','Buy cost','Sell value','GP per potion','Profit %','GP / XP','Notes'];
    const body=rows.map(r=>[r.name,r.xp,r.baseDoses,r.expDoses.toFixed(2),Math.round(r.cost??0),Math.round(r.revenue??0),Math.round(r.profit??0),r.profitPct==null?'':r.profitPct.toFixed(2),r.gpxp==null?'':r.gpxp.toFixed(5),r.note].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
    return [hdr.join(','),...body].join('\n');
  }
  function sortBy(rows,key,asc=true){ const a=[...rows]; a.sort((x,y)=>{const vx=x[key], vy=y[key]; if(vx==null&&vy==null) return 0; if(vx==null) return 1; if(vy==null) return -1; return (asc?1:-1)*(vx>vy?1:vx<vy?-1:0)}); return a; }

  // --- HARD-CODED RECIPES (product4 only) ---
  const RECIPES=[
    {name:'Attack potion', baseDoses:3, xp:25, product4:'Attack potion(4)', components:['Guam potion (unf)','Eye of newt']},
    {name:'Prayer potion', baseDoses:3, xp:87.5, product4:'Prayer potion(4)', components:['Ranarr potion (unf)','Snape grass']},

    {name:'Stamina(1)', baseDoses:1, xp:25.5, product4:'Stamina potion(4)', components:[{name:'Super energy(1)'},{name:'Amylase crystal', qty:1}]},
    {name:'Stamina(2)', baseDoses:2, xp:51.0, product4:'Stamina potion(4)', components:[{name:'Super energy(2)'},{name:'Amylase crystal', qty:2}]},
    {name:'Stamina(3)', baseDoses:3, xp:76.5, product4:'Stamina potion(4)', components:[{name:'Super energy(3)'},{name:'Amylase crystal', qty:3}]},
    {name:'Stamina(4)', baseDoses:4, xp:102.0, product4:'Stamina potion(4)', components:[{name:'Super energy(4)'},{name:'Amylase crystal', qty:4}]},

    {name:'Anti-venom (1)', baseDoses:1, xp:30, product4:'Anti-venom(4)', components:[{name:"Antidote++(1)"},{name:"Zulrah's scales", qty:5}]},
    {name:'Anti-venom (2)', baseDoses:2, xp:60, product4:'Anti-venom(4)', components:[{name:"Antidote++(2)"},{name:"Zulrah's scales", qty:10}]},
    {name:'Anti-venom (3)', baseDoses:3, xp:90, product4:'Anti-venom(4)', components:[{name:"Antidote++(3)"},{name:"Zulrah's scales", qty:15}]},
    {name:'Anti-venom (4)', baseDoses:4, xp:120, product4:'Anti-venom(4)', components:[{name:"Antidote++(4)"},{name:"Zulrah's scales", qty:20}]},
    {name:'Anti-venom+ (4)', baseDoses:4, xp:125, product4:'Anti-venom+(4)', components:[{name:'Anti-venom(4)'},{name:'Torstol', qty:1}]},

    {name:'Extended antifire (1)', baseDoses:1, xp:27.5, product4:'Extended antifire(4)', components:[{name:'Antifire potion(1)'},{name:'Lava scale shard', qty:1}]},
    {name:'Extended antifire (2)', baseDoses:2, xp:55, product4:'Extended antifire(4)', components:[{name:'Antifire potion(2)'},{name:'Lava scale shard', qty:2}]},
    {name:'Extended antifire (3)', baseDoses:3, xp:82.5, product4:'Extended antifire(4)', components:[{name:'Antifire potion(3)'},{name:'Lava scale shard', qty:3}]},
    {name:'Extended antifire (4)', baseDoses:4, xp:110, product4:'Extended antifire(4)', components:[{name:'Antifire potion(4)'},{name:'Lava scale shard', qty:4}]},

    {name:'Super antifire (4)', baseDoses:4, xp:130, product4:'Super antifire potion(4)', components:[{name:'Antifire potion(4)'},{name:'Crushed superior dragon bones', qty:1}]},

    {name:'Extended super antifire (1)', baseDoses:1, xp:40, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(1)'},{name:'Lava scale shard', qty:1}]},
    {name:'Extended super antifire (2)', baseDoses:2, xp:80, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(2)'},{name:'Lava scale shard', qty:2}]},
    {name:'Extended super antifire (3)', baseDoses:3, xp:120, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(3)'},{name:'Lava scale shard', qty:3}]},
    {name:'Extended super antifire (4)', baseDoses:4, xp:160, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(4)'},{name:'Lava scale shard', qty:4}]},

    {name:'Divine super combat (1)', baseDoses:1, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine super combat (2)', baseDoses:2, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine super combat (3)', baseDoses:3, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine super combat (4)', baseDoses:4, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine super attack (1)', baseDoses:1, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine super attack (2)', baseDoses:2, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine super attack (3)', baseDoses:3, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine super attack (4)', baseDoses:4, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine super strength (1)', baseDoses:1, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine super strength (2)', baseDoses:2, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine super strength (3)', baseDoses:3, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine super strength (4)', baseDoses:4, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine super defence (1)', baseDoses:1, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine super defence (2)', baseDoses:2, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine super defence (3)', baseDoses:3, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine super defence (4)', baseDoses:4, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine ranging (1)', baseDoses:1, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine ranging (2)', baseDoses:2, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine ranging (3)', baseDoses:3, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine ranging (4)', baseDoses:4, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine magic (1)', baseDoses:1, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine magic (2)', baseDoses:2, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine magic (3)', baseDoses:3, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine magic (4)', baseDoses:4, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine bastion (1)', baseDoses:1, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine bastion (2)', baseDoses:2, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine bastion (3)', baseDoses:3, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine bastion (4)', baseDoses:4, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Divine battlemage (1)', baseDoses:1, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(1)'},{name:'Crystal dust', qty:1}]},
    {name:'Divine battlemage (2)', baseDoses:2, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(2)'},{name:'Crystal dust', qty:2}]},
    {name:'Divine battlemage (3)', baseDoses:3, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(3)'},{name:'Crystal dust', qty:3}]},
    {name:'Divine battlemage (4)', baseDoses:4, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(4)'},{name:'Crystal dust', qty:4}]},

    {name:'Extended anti-venom+ (1)', baseDoses:1, xp:20, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(1)'},{name:'Araxyte venom sack', qty:1}]},
    {name:'Extended anti-venom+ (2)', baseDoses:2, xp:40, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(2)'},{name:'Araxyte venom sack', qty:2}]},
    {name:'Extended anti-venom+ (3)', baseDoses:3, xp:60, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(3)'},{name:'Araxyte venom sack', qty:3}]},
    {name:'Extended anti-venom+ (4)', baseDoses:4, xp:80, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(4)'},{name:'Araxyte venom sack', qty:4}]},

    {name:'Bastion potion', baseDoses:3, xp:155, product4:'Bastion potion(4)', components:[{name:'Cadantine blood potion (unf)'},{name:'Wine of zamorak'}]},
    {name:'Battlemage potion', baseDoses:3, xp:155, product4:'Battlemage potion(4)', components:[{name:'Cadantine blood potion (unf)'},{name:'Potato cactus'}]},
    {name:'Compost potion', baseDoses:3, xp:60, product4:'Compost potion(4)', components:[{name:'Harralander potion (unf)'},{name:'Volcanic ash'}]},
    {name:'Serum 207', baseDoses:3, xp:50, product4:'Serum 207(4)', components:[{name:'Tarromin potion (unf)'},{name:'Ashes'}]},

    {name:'Super combat potion (4)', baseDoses:4, xp:150, product4:'Super combat potion(4)', components:[{name:'Super attack(4)'},{name:'Super strength(4)'},{name:'Super defence(4)'},{name:'Torstol', qty:1}]}
  ];

  let rows=[]; let sortKey='profit', sortAsc=false;
  async function compute(){ if(!MAP||!PRICE) return; const base = RECIPES.map(computeRow); rows = sortBy(base, sortKey, sortAsc); renderRows(rows); }

  ['change','input'].forEach(evt=>{ els.buyBasis.addEventListener(evt, compute); els.sellBasis.addEventListener(evt, compute); els.tax.addEventListener(evt, compute); els.dustMode.addEventListener(evt, compute); });

  const thead=document.querySelector('#tbl thead');
  thead.addEventListener('click', (e)=>{ const th=e.target.closest('th'); if(!th) return; const k=th.dataset.k; if(!k) return; if(sortKey===k){ sortAsc=!sortAsc; } else { sortKey=k; sortAsc=true; } rows=sortBy(rows,sortKey,sortAsc); renderRows(rows); });

  els.copyCsv.addEventListener('click', ()=>{ try{ navigator.clipboard.writeText(toCsv(rows)); alert('CSV copied.'); }catch(e){ alert('Copy failed: '+e.message);} });
  els.downloadCsv.addEventListener('click', ()=>{ const blob=new Blob([toCsv(rows)],{type:'text/csv'}); const url=URL.createObjectURL(blob); const a=Object.assign(document.createElement('a'),{href:url,download:'herblore-live.csv'}); document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); });

  // Manual refresh button
  if(els.refreshNow){
    els.refreshNow.addEventListener('click', async ()=>{
      els.status.textContent='Refreshing…';
      els.refreshNow.disabled = true;
      try{ await fetchLatest(); await compute(); }
      catch(e){ els.status.textContent='Refresh error: '+e.message; }
      finally{ els.refreshNow.disabled = false; }
    });
  }

  // Auto-refresh timer
  let timer=null; function setTimer(){ if(timer) clearInterval(timer); const mins=Math.max(0, Number(els.refreshMins.value||0)); if(mins>0){ timer=setInterval(async()=>{ try{ await fetchLatest(); await compute(); }catch(e){ els.status.textContent='Refresh error: '+e.message; } }, mins*60*1000);} }
  els.refreshMins.addEventListener('change', setTimer);

  (async function boot(){ try{ await fetchMapping(); await fetchLatest(); await compute(); setTimer(); } catch(e){ console.error(e); els.status.textContent='Error: '+e.message; } })();
})();
</script>
</body>
</html>
