<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>OSRS Herblore ‚Äî Live GP/XP</title>
<style>
/* ===================== THEME & TOKENS ====================== */
:root{
  --bg:#0a0f17; /* page background */
  --panel:#0f1726; /* cards & table */
  --panel-2:#0b1220; /* inputs */
  --ink:#e8edf7; /* text */
  --muted:#96a3b8; /* secondary text */
  --border:#1e2a40; /* subtle borders */
  --accent:#7aa6ff; /* primary accent */
  --accent-2:#8be5ff; /* secondary accent */
  --ok:#10b981; /* positive */
  --warn:#f59e0b; /* warning */
  --bad:#ef4444; /* negative */
  --shadow:0 10px 30px rgba(0,0,0,.35);
  --radius:16px;
  --radius-sm:10px;
  --fx-fast:150ms cubic-bezier(.2,.7,.2,1);
  --fx-med:260ms cubic-bezier(.2,.7,.2,1);
  --fx-slow:420ms cubic-bezier(.2,.7,.2,1);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  color:var(--ink);
  background:radial-gradient(1200px 800px at 80% -10%, rgba(122,166,255,.12), transparent 60%),
             radial-gradient(900px 600px at 10% -10%, rgba(139,229,255,.08), transparent 60%),
             linear-gradient(180deg,var(--bg),#0b1220 40%, #0a1020 100%);
  font:14px/1.5 system-ui,Segoe UI,Roboto,Ubuntu,Helvetica,Arial,sans-serif;
  -webkit-font-smoothing:antialiased;
  text-rendering:optimizeLegibility;
}
a{color:var(--accent); text-decoration:none}
a:hover{text-decoration:underline}
header{
  position:sticky; top:0; z-index:10; padding:18px 20px;
  backdrop-filter:saturate(140%) blur(8px);
  background:linear-gradient(180deg,rgba(13,21,38,.9),rgba(13,21,38,.55));
  border-bottom:1px solid rgba(122,166,255,.08);
}
h1{margin:0 0 6px; font-size:20px; font-weight:800; letter-spacing:.2px}
.sub{color:var(--muted); font-size:12px}
main{max-width:1220px; margin:18px auto 72px; padding:0 16px}
/* Card */
.card{background:var(--panel); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); overflow:hidden}
.card .hd{display:flex; gap:12px; flex-wrap:wrap; align-items:center; padding:14px 16px; border-bottom:1px solid var(--border)}
/* Pills & status */
.pill{display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px; background:linear-gradient(180deg,#0d1423,#0b1220); border:1px solid #26344f; font-size:12px; color:var(--muted)}
.right{margin-left:auto}
.busy::before{content:""; width:10px; height:10px; border:2px solid #6b7fa6; border-top-color:var(--accent); border-radius:50%; display:inline-block; animation:spin 1s linear infinite}
@keyframes spin {to{transform:rotate(360deg)}}
/* Controls */
.controls{display:grid; grid-template-columns: repeat(auto-fit,minmax(230px,1fr)); gap:12px; padding:12px 16px; background:linear-gradient(180deg,#0f1726,#0c1527)}
label{display:flex; align-items:center; gap:8px; color:var(--muted)}
select,input[type="checkbox"],input[type="number"]{background:var(--panel-2); color:var(--ink); border:1px solid #223047; border-radius:var(--radius-sm); padding:9px 10px; width:100%}
.autorefresh .row{display:flex; align-items:center; gap:8px; width:100%}
/* Buttons */
.btn{appearance:none; border:1px solid #2b3a55; background:linear-gradient(180deg,#0e1526,#0d1423); color:var(--ink); padding:9px 12px; border-radius:12px; cursor:pointer; transition:transform var(--fx-fast), border-color var(--fx-fast), box-shadow var(--fx-fast)}
.btn:hover{border-color:#3f567e; transform:translateY(-1px)}
.btn:active{transform:translateY(0)}
.btn.primary{border-color:transparent; background:linear-gradient(135deg, #6292ff, #58d3ff); color:#041226; font-weight:700}
.btn.primary:hover{filter:brightness(1.05)}
button:disabled{opacity:.6; cursor:not-allowed}
/* Table */
.tablewrap{overflow:auto; max-height:70vh; overscroll-behavior:contain}
.tablewrap::-webkit-scrollbar{height:10px; width:10px}
.tablewrap::-webkit-scrollbar-thumb{background:#24324f; border-radius:20px}
table{border-collapse:separate; border-spacing:0; width:100%; font-variant-numeric:tabular-nums}
th,td{padding:10px 12px; border-bottom:1px solid var(--border); white-space:nowrap; vertical-align:middle}
th{position:sticky; top:0; background:linear-gradient(180deg,#0e1627,#0d1526); text-align:left; font-weight:700; z-index:3; cursor:pointer}
th .ico{margin-left:6px; opacity:.6; font-size:11px}
th.sorted{color:#d7e0ff}
th.sorted.asc .ico{opacity:1}
th.sorted.desc .ico{opacity:1}
tr:hover{background:#0c1424}
tr.row[aria-expanded="true"]{background:#101a2f}
.num{text-align:right}
.ok{color:var(--ok)}
.bad{color:var(--bad)}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.foot{color:var(--muted); font-size:12px; padding:10px 16px}
.hint{color:var(--muted); font-size:12px}
/* Make notes wrap and separate visually */
#tbl td:last-child, #tbl th:last-child{ border-left:1px solid #223356; }
.notes{ white-space:normal; overflow-wrap:anywhere; line-height:1.35 }
/* Chevron + row focus */
.namecell{display:flex; align-items:center; gap:10px}
.chev{width:10px; height:10px; display:inline-block; transform:rotate(0deg); transition:transform var(--fx-med)}
.row:focus{outline:2px solid rgba(122,166,255,.7); outline-offset:-2px}
.row[aria-expanded="true"] .chev{transform:rotate(90deg)}
/* Slow icon */
.slow{display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; margin-left:6px; border-radius:50%; background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.35); font-size:12px; cursor:help}
.slow::after{content:""}
/* Low volume icon */
.lowvol{display:inline-flex; align-items:center; justify-content:center; width:18px; height:18px; margin-left:6px; border-radius:50%; background:rgba(245,158,11,.15); border:1px solid rgba(245,158,11,.35); font-size:12px; cursor:help}
.lowvol::after{content:""}
/* Detail row animation (collapsible) */
tr.detail td{ padding:0; background:#0a1120; border-bottom:1px solid var(--border) }
.expand{
  overflow:hidden; max-height:0; opacity:0; transform:translateY(-4px);
  transition:max-height var(--fx-slow), opacity var(--fx-med), transform var(--fx-med);
}
tr.detail.open .expand{ opacity:1; transform:translateY(0) }
/* When open we add padding & border via inner wrapper so closed state stays compact */
.expand-inner{ padding:12px 16px; border-top:1px solid #15223a; background:linear-gradient(180deg,#0b1324,#0a1222) }
.expand h4{ margin:0 0 8px; font-size:14px; font-weight:800 }
.expand .meta{ color:var(--muted); font-size:12px; margin-bottom:8px }
.expand table{ width:100%; border-collapse:separate; border-spacing:0; }
.expand th, .expand td{ border-bottom:1px solid #16223a; padding:8px 10px; white-space:nowrap; vertical-align:top }
.expand th + th, .expand td + td{ border-left:1px solid #16223a; }
.expand .num{ padding-right:14px; }
.expand th{ background:#0c1629; position:static; cursor:default }
.expand td:last-child{ white-space:normal; overflow-wrap:anywhere; }
.kbd{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; padding:1px 6px; border:1px solid #2b3a55; border-radius:6px; background:#0d1423; color:#muted; font-size:11px }
/* Empty state */
.empty{padding:28px; text-align:center; color:var(--muted)}
/* Tooltip / Abbreviation styling */
abbr[title]{text-decoration:none; border-bottom:1px dotted #3b4a6a; cursor:help}
.th-full{display:inline}
.th-short{display:none}
@media (max-width: 1100px){
  th .th-full{display:none}
  th .th-short{display:inline}
}
/* Utility */
.fade-in{animation:fadeIn var(--fx-slow)}
@keyframes fadeIn{from{opacity:.6; transform:translateY(4px)} to{opacity:1; transform:translateY(0)}}
</style>
</head>
<body>
<header>
  <h1>OSRS Herblore ‚Äî Live GP/XP</h1>
  <div class="sub">
    Live pricing via <span class="pill">prices.runescape.wiki</span>. Per-dose valuation from the (4) item. Amulet +15% expected dose (cap 4). Goggles ‚àí10% secondary save (excl. crystal dust). Optional ECTS pricing. Optional Alch. amulet charge cost.
    <span class="pill" title="Recipes that craft slower have a snail icon. GP/hr uses base rate √ó per-recipe modifier.">üêå = slowed</span>
    <span class="pill" title="Low sale volume warning. Shown when the (4) item‚Äôs average hourly buyer-side volume over the last 7 days is less than 1√ó your effective potions/hr (after üêå). Hover the icon for the daily volume.">üìâ = low volume</span>
  </div>
</header>

<main class="fade-in">
  <section class="card">
    <div class="hd">
      <strong>Options</strong>
      <span id="status" class="pill busy">Loading‚Ä¶</span>
      <span id="lastUpdate" class="pill right">‚Äî</span>
    </div>
    <div class="controls">
      <label>Buy price basis
        <select id="buyBasis">
          <option value="mid">Mid ((high+low)/2)</option>
          <option value="high">Instant Buy (avgHigh)</option>
          <option value="low">Low (avgLow)</option>
        </select>
      </label>
      <label>Sell price basis
        <select id="sellBasis">
          <option value="mid">Mid ((high+low)/2)</option>
          <option value="low">Instant Sell (avgLow)</option>
          <option value="high">High (avgHigh)</option>
        </select>
      </label>
      <label>GE tax on sale (2%) <input id="tax" type="checkbox" checked> </label>
      <label>Crystal dust pricing
        <select id="dustMode">
          <option value="ects">From Enhanced crystal teleport seed ‚Üí 150 shards ‚Üí 10 dust/shard</option>
          <option value="market">Direct (Crystal dust)</option>
        </select>
      </label>
      <label>Base potions/hr <input id="pph" type="number" min="100" step="50" value="2200" /> </label>

      <!-- UPDATED: Include cost of Alchemist's-amulet charges sourced from Amulets of chemistry (fixed 10 charges per amulet) -->
      <label title="Include the expected cost of Alchemist‚Äôs-amulet charges (10 charges per Chemistry amulet)">
        Include Alch. amulet cost
        <input id="chemCost" type="checkbox" checked />
      </label>
      <!-- /UPDATED -->

      <label class="autorefresh">Auto-refresh (min)
        <div class="row">
          <input id="refreshMins" type="number" min="0" step="1" value="10" />
          <button class="btn" id="refreshNow" type="button" title="Fetch latest and recompute">Refresh now</button>
        </div>
      </label>
      <label title="Hide rows marked with the low volume icon (üìâ)">Hide low-volume (üìâ)
        <input id="hideLowVol" type="checkbox" />
      </label>
    </div>
  </section>

  <section class="card" style="margin-top:14px">
    <div class="hd">
      <strong>Results (valued using 4-dose prices per dose)</strong>
      <div class="right" style="display:flex; gap:8px">
        <button class="btn" id="copyCsv">Copy CSV</button>
        <button class="btn primary" id="downloadCsv">Download CSV</button>
      </div>
    </div>

    <div class="tablewrap">
      <table id="tbl" aria-live="polite">
        <thead>
        <tr>
          <th data-k="name">Potion <span class="ico">‚Üï</span></th>
          <th data-k="xp" class="num">XP <span class="ico">‚Üï</span></th>
          <th data-k="baseDoses" class="num">
            <span class="th-full">Base doses</span>
            <abbr class="th-short" title="Base doses: the number of doses the input potion contributes before any amulet effect. e.g. Stamina(3) ‚Üí 3; (4)-dose recipes ‚Üí 4.">Base</abbr>
            <span class="ico">‚Üï</span>
          </th>
          <th data-k="expDoses" class="num">
            <span class="th-full">Expected doses</span>
            <abbr class="th-short" title="Expected doses: min(4, Base + 0.15). Amulet adds +0.15 expected dose when Base&lt;4 (cap 4). Goggles do not change doses; they only reduce secondary quantities.">Exp.</abbr>
            <span class="ico">‚Üï</span>
          </th>
          <th data-k="cost" class="num">Buy cost <span class="ico">‚Üï</span></th>
          <th data-k="revenue" class="num">Sell value <span class="ico">‚Üï</span></th>
          <th data-k="profit" class="num">GP / potion <span class="ico">‚Üï</span></th>
          <th data-k="gphr" class="num">GP / hr <span class="ico">‚Üï</span></th>
          <th data-k="profitPct" class="num">Profit % <span class="ico">‚Üï</span></th>
          <th data-k="gpxp" class="num">GP / XP <span class="ico">‚Üï</span></th>
          <th>Notes</th>
        </tr>
        </thead>
        <tbody id="tbody">
          <tr><td colspan="11" class="empty">Fetching data‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <div class="foot">
      Mechanics: Amulet adds 0.15 expected dose when base&lt;4 (cap 4). Goggles save 10% of secondaries (excl. dust). Crystal dust can be valued from ECTS. Optional cost for Alchemist‚Äôs-amulet charges (from Amulets of chemistry).
      GP/hr uses your <b>Base potions/hr</b> √ó per-recipe slow modifier. <b>üêå</b> icon denotes slowed recipes. <b>üìâ</b> denotes low sale volume (7-day hourly avg &lt; 1√ó effective p/h).
    </div>
  </section>
</main>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const fmt = n => (n==null || Number.isNaN(n))? '‚Äî' : n.toLocaleString();
  const pct = n => (n==null || Number.isNaN(n))? '‚Äî' : ((n>=0?'+':'') + n.toFixed(1) + '%');
  const n2 = n => (n==null || Number.isNaN(n))? null : +n;

  const HEADERS = {'Accept':'application/json','Api-User-Agent':'HerbLive/3.0 (single-file browser app)'};

  const els = {
    status: $('#status'), lastUpdate: $('#lastUpdate'),
    buyBasis: $('#buyBasis'), sellBasis: $('#sellBasis'),
    tax: $('#tax'), dustMode: $('#dustMode'),
    refreshMins: $('#refreshMins'), tbody: $('#tbody'), tbl: $('#tbl'),
    copyCsv: $('#copyCsv'), downloadCsv: $('#downloadCsv'), refreshNow: $('#refreshNow'),
    pph: $('#pph'), hideLowVol: $('#hideLowVol'),
    chemCost: $('#chemCost') // UPDATED: removed chemCharges
  };

  function setStatus(text, busy){
    els.status.textContent=text;
    els.status.classList.toggle('busy', !!busy);
  }

  function parseDoseSuffix(name){ const m = String(name).trim().match(/\((\d)\)$/); return m? Number(m[1]) : null; }
  const isPotionName = (name)=> /\(\d\)$/.test(name);
  const isUnf = (name)=> /\(unf\)/i.test(name);
  const esc = (s)=> String(s).replace(/[&<>"']/g, c=> ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

  // ---- Per-recipe slow flags ----
  const SLOW_RULES = [
    { test: n => /Super combat potion/i.test(n), reduce: 0.60, why: 'Requires 4 different ingredients ‚Üí more banking.' },
    { test: n => /Anti-venom\+/i.test(n) && !/Extended/i.test(n), reduce: 0.35, why: 'Secondary cannot use reagent pouch ‚Üí more banking.' },
    { test: n => /Extended anti-venom\+/i.test(n), reduce: 0.33, why: '3 Tick craft time' }
  ];
  function slowMeta(name){
    for(const r of SLOW_RULES){ if(r.test(name)) return r; }
    return null;
  }

  let MAP=null, PRICE=null, VOLUME=null;

  async function fetchMapping(){
    setStatus('Loading mapping‚Ä¶', true);
    const r=await fetch('https://prices.runescape.wiki/api/v1/osrs/mapping',{headers:HEADERS});
    if(!r.ok) throw new Error('mapping '+r.status);
    const arr=await r.json();
    const map=new Map();
    for(const it of arr){ map.set(it.name.toLowerCase(), it); }
    MAP=map;
    setStatus('Mapping ready ('+arr.length+' items)');
  }

  async function fetchLatest(){
    setStatus('Fetching latest‚Ä¶', true);
    const r=await fetch('https://prices.runescape.wiki/api/v1/osrs/latest',{headers:HEADERS});
    if(!r.ok) throw new Error('latest '+r.status);
    const j=await r.json();
    PRICE=j.data;
    els.lastUpdate.textContent='Updated '+new Date().toLocaleTimeString();
    setStatus('Prices ready');
  }

  function findItem(name){
    return MAP?.get(String(name).trim().toLowerCase()) || null;
  }

  function priceFor(nameOrId){
    if(!PRICE) return null;
    let id=null;
    if(typeof nameOrId==='number' || /^\d+$/.test(String(nameOrId))){
      id=String(nameOrId);
    } else {
      const it=findItem(nameOrId);
      if(!it) return null;
      id=String(it.id);
    }
    const p=PRICE[id];
    if(!p) return null;
    return {id,high:n2(p.high),low:n2(p.low)};
  }

  function basisVal(p,basis){
    if(!p) return null;
    if(basis==='high') return n2(p.high);
    if(basis==='low') return n2(p.low);
    return (p.high!=null&&p.low!=null)? (p.high+p.low)/2 : (p.high ?? p.low ?? null);
  }
  function basisLabel(b){ return b==='high'? 'High' : b==='low'? 'Low' : 'Mid'; }

  function perDoseFrom4(itemName, basis){
    const d=parseDoseSuffix(itemName);
    if(d==null){
      const p=priceFor(itemName);
      return basisVal(p, basis);
    }
    const base=itemName.replace(/\((\d)\)$/,'(4)');
    const p4=priceFor(base);
    const v4=basisVal(p4, basis);
    return v4!=null? (v4/4) : null;
  }

  function dustUnitFromECTS(basis){
    const ects=priceFor('Enhanced crystal teleport seed');
    const v=basisVal(ects, basis);
    return v==null? null : v/(150*10); // 150 shards per seed; 10 dust per shard
  }

  function isSecondary(name){ return !(isPotionName(name) || isUnf(name)); }

  const pricesUrl = (id)=> id? `https://prices.runescape.wiki/osrs/item/${id}` : null;

  // ---------- Volume fetching (7d hourly avg, buyer-side) ----------
  async function fetchItemVolumeStats(id){
    const idStr=String(id);
    const base='https://prices.runescape.wiki/api/v1/osrs';
    const nowSec=Math.floor(Date.now()/1000);
    const hours=24*7;
    const start=nowSec - hours*3600;

    // Try 1: hourly timeseries
    try{
      const u=`${base}/timeseries?timestep=1h&id=${encodeURIComponent(idStr)}&start=${start}&end=${nowSec}`;
      const r=await fetch(u,{headers:HEADERS});
      if(r.ok){
        const j=await r.json();
        const arr=Array.isArray(j?.data)? j.data : [];
        const vols=arr.map(o=>n2(o.highPriceVolume ?? o.avgHighPriceVolume ?? ((o.highPriceVolume??0)+(o.lowPriceVolume??0)))).filter(v=>v!=null);
        if(vols.length){
          const sum=vols.reduce((a,b)=>a+b,0);
          const hourlyAvg=sum/vols.length;
          return { hourlyAvg, dailyAvg: hourlyAvg*24, sampleH: vols.length, source:'ts-1h' };
        }
      }
    }catch(_){}

    // Try 2: daily timeseries ‚Üí hourly
    try{
      const u=`${base}/timeseries?timestep=24h&id=${encodeURIComponent(idStr)}`;
      const r=await fetch(u,{headers:HEADERS});
      if(r.ok){
        const j=await r.json();
        const arr=Array.isArray(j?.data)? j.data : [];
        const days=arr.slice(-7);
        const vols=days.map(o=>n2(o.highPriceVolume ?? o.avgHighPriceVolume ?? ((o.highPriceVolume??0)+(o.lowPriceVolume??0)))).filter(v=>v!=null);
        if(vols.length){
          const dayAvg = vols.reduce((a,b)=>a+b,0)/vols.length;
          return { hourlyAvg: dayAvg/24, dailyAvg: dayAvg, sampleH: vols.length*24, source:'ts-24h' };
        }
      }
    }catch(_){}

    // Try 3: last hour snapshot
    try{
      const u=`${base}/1h?id=${encodeURIComponent(idStr)}`;
      const r=await fetch(u,{headers:HEADERS});
      if(r.ok){
        const j=await r.json();
        const rec = j?.data?.[idStr] || null;
        const hv = n2(rec?.highPriceVolume ?? rec?.avgHighPriceVolume ?? ((rec?.highPriceVolume??0)+(rec?.lowPriceVolume??0)));
        if(hv!=null){
          return { hourlyAvg: hv, dailyAvg: hv*24, sampleH: 1, source:'1h' };
        }
      }
    }catch(_){}

    return { hourlyAvg: null, dailyAvg: null, sampleH: 0, source:'none' };
  }

  async function fetchVolumes(){
    if(!MAP) return;
    setStatus('Loading volumes‚Ä¶', true);
    const ids = [...new Set(RECIPES.map(r => findItem(r.product4)?.id).filter(Boolean))];
    const volMap = new Map();
    await Promise.all(ids.map(async (id)=>{
      const v = await fetchItemVolumeStats(id);
      volMap.set(String(id), v);
    }));
    VOLUME = volMap;
    setStatus('Volumes ready');
  }

  function computeRow(rec){
    const buyB=els.buyBasis.value, sellB=els.sellBasis.value, tax=els.tax.checked? 0.02 : 0;

    const baseD=rec.baseDoses||3;
    const expD=Math.min(4, baseD + 0.15);

    let cost=0;
    const missing=[];
    const parts=[];

    for(const raw of rec.components){
      const c = (typeof raw==='string')? {name:raw.trim(), qty:1} : {...raw};
      const nm = c.name;
      let unit=null, via4=false, viaECTS=false, id=null;

      if(/crystal\s*dust/i.test(nm)){
        if(els.dustMode.value==='ects'){
          unit = dustUnitFromECTS(buyB); viaECTS=true;
        } else {
          const pd=priceFor('Crystal dust'); unit=basisVal(pd,buyB);
        }
        const it=findItem('Crystal dust'); id=it?.id ?? null;

      } else if(isPotionName(nm)){
        const perDose=perDoseFrom4(nm, buyB);
        via4=true; unit=perDose; // per dose
        const it4=findItem(nm.replace(/\((\d)\)$/,'(4)')) || findItem(nm);
        id=it4?.id ?? null;

      } else {
        const p=priceFor(nm);
        unit=basisVal(p,buyB);
        id=findItem(nm)?.id ?? null;
      }

      const isSec = isSecondary(nm);
      const save = (isSec && !/crystal\s*dust/i.test(nm))? 0.10 : 0;

      const qtyBase = isPotionName(nm) ? (parseDoseSuffix(nm) || 1) : (c.qty ?? 1);
      const effQty = qtyBase * (1 - save);
      const total = unit==null? null : unit * effQty;
      if(unit==null) missing.push(nm);

      cost += total ?? 0;
      parts.push({ name:nm, id, url:pricesUrl(id), qty:qtyBase, effQty, unit, total, basis:buyB, via4, viaECTS, isSecondary:isSec, saved:save });
    }

    // === UPDATED: expected cost for Alchemist‚Äôs-amulet charges (from Amulets of chemistry, fixed 10 charges/ammy) ===
    const extraDoses = Math.max(0, expD - baseD); // model's +0.15 when base<4
    if(els.chemCost?.checked && extraDoses > 0){
      const chemPrice = priceFor('Amulet of chemistry');
      const perAmmy   = basisVal(chemPrice, buyB);
      const chargesPerAmmy = 10; // fixed
      const gpPerCharge = (perAmmy != null) ? (perAmmy / chargesPerAmmy) : null;
      const added = (gpPerCharge != null) ? gpPerCharge * extraDoses : null;

      if(gpPerCharge == null) missing.push('Amulet of chemistry');

      cost += added ?? 0;

      const chemItem = findItem('Amulet of chemistry');
      parts.push({
        name: "Alchemist's amulet charges",
        id: chemItem?.id ?? null,
        url: pricesUrl(chemItem?.id ?? null),
        qty: extraDoses,
        effQty: extraDoses,
        unit: gpPerCharge,
        total: added,
        basis: buyB,
        via4:false, viaECTS:false, isSecondary:false, saved:0
      });
    }
    // === END UPDATED ===

    const p4=priceFor(rec.product4);
    const v4=basisVal(p4, sellB);
    const perDoseSell = v4!=null? (v4/4) : null;
    const gross = perDoseSell!=null? (perDoseSell * expD) : null;
    const revenue = gross!=null? gross * (1 - tax) : null;
    const profit = (revenue!=null && cost!=null)? (revenue - cost) : null;
    const gpxp = (rec.xp>0 && profit!=null)? (profit/rec.xp) : null;
    const profitPct = (profit!=null && cost>0)? (profit/cost*100) : null;

    // GP/hr using base PPH and slow modifier
    const baseRate = Math.max(0, Number(els.pph?.value||0) || 2200);
    const slow = slowMeta(rec.name);
    const mult = slow ? (1 - slow.reduce) : 1;
    const effRate = baseRate * mult;
    const gphr = (profit!=null) ? (profit * effRate) : null;

    const noteBits=[];
    if(perDoseSell==null) noteBits.push(`Missing price: ${rec.product4}`);
    if(missing.length) noteBits.push(`Missing price: ${missing.join(', ')}`);
    noteBits.push('Sell using (4) per-dose');

    // Output meta
    const prodItem = findItem(rec.product4);
    const out = { productName: rec.product4, id: prodItem?.id ?? null, url: pricesUrl(prodItem?.id ?? null), perDoseSell, expDoses:expD, gross, net:revenue, taxRate:tax, basis:sellB };

    // Slow (üêå) info
    const slowInfo = slow ? {
      reduce: slow.reduce, mult, why: slow.why, effRate, baseRate,
      title: `${Math.round(slow.reduce*100)}% slower ‚Äî ~${Math.round(effRate)} p/h (base ${Math.round(baseRate)})\nReason: ${slow.why}`
    } : null;

    // Low-volume (üìâ) check using 7-day hourly average buyer-side volume
    let lowVol=null;
    if(out.id && VOLUME?.has(String(out.id))){
      const v = VOLUME.get(String(out.id));
      if(v?.hourlyAvg!=null){
        const threshold = effRate * 1; // 1√ó production/hr
        const warn = v.hourlyAvg < threshold;
        lowVol = {
          warn,
          hourlyAvg: v.hourlyAvg,
          dailyAvg: v.dailyAvg,
          sampleH: v.sampleH,
          threshold,
          title: `Low sale volume ‚Äî ~${Math.round(v.dailyAvg||0).toLocaleString()}/day (avg over ${v.sampleH}h)\nYour effective production: ~${Math.round(effRate).toLocaleString()}/h; needs ‚â•${Math.round(threshold).toLocaleString()}/h (1√ó).`
        };
        if(warn){
          noteBits.push(`Low volume: ~${Math.round(v.dailyAvg||0).toLocaleString()}/day over 7d; needs ‚â•${Math.round(threshold).toLocaleString()}/h (1√ó)`);
        }
      }
    }

    return {
      name:rec.name, xp:rec.xp, baseDoses:rec.baseDoses||3, expDoses:expD,
      cost, revenue, profit, profitPct, gpxp, gphr,
      note:noteBits.join(' ¬∑ '), parts, out, slow: slowInfo, lowVol
    };
  }

  function rowDetailHTML(r){
    const out=r.out;
    const head = `Output: ${out.url? `<a href="${out.url}" target="_blank" rel="noopener">${esc(out.productName)}</a>` : esc(out.productName)} ‚Äî per-dose sell (${basisLabel(out.basis)}) <span class="mono">${fmt(Math.round(out.perDoseSell??0))}</span> √ó expected doses <span class="mono">${out.expDoses.toFixed(2)}</span> ‚Üí gross <span class="mono">${fmt(Math.round(out.gross??0))}</span>${out.taxRate? `, after ${Math.round(out.taxRate*100)}% tax <span class=mono>${fmt(Math.round(out.net??0))}</span>`:''}`;

    const rows = r.parts.map(p=>{
      const notes = [p.via4? 'per-dose from (4)':'' , p.viaECTS? 'via ECTS':'' , (p.saved>0? 'goggles ‚àí10% save':'')].filter(Boolean).join('; ');
      const name = p.url? `<a href="${p.url}" target="_blank" rel="noopener">${esc(p.name)}</a>` : esc(p.name);
      return `<tr>
        <td>${name}</td>
        <td class="num mono">${fmt(p.qty)}</td>
        <td class="num mono">${fmt(p.effQty.toFixed(3))}</td>
        <td class="num mono">${fmt(Math.round(p.unit??0))}</td>
        <td class="num mono">${fmt(Math.round(p.total??0))}</td>
        <td class="hint">${esc(notes)}</td>
      </tr>`;
    }).join('');

    const speed = r.slow ? `<div class="hint" style="margin-bottom:6px">üêå <b>Slowed recipe:</b> ${Math.round(r.slow.reduce*100)}% slower ‚Üí effective rate ‚âà <span class="mono">${fmt(Math.round(r.slow.effRate))}</span> p/h (base <span class="mono">${fmt(Math.round(r.slow.baseRate))}</span> p/h). ${esc(r.slow.why)}</div>` : '';

    const vol = r.lowVol && r.lowVol.hourlyAvg!=null ? `<div class="hint" style="margin-bottom:6px">${r.lowVol.warn? 'üìâ <b>Low sale volume:</b>' : '‚úì <b>Volume OK:</b>'} ~<span class="mono">${fmt(Math.round(r.lowVol.dailyAvg))}</span>/day (avg over ${fmt(r.lowVol.sampleH)}h). Threshold: ‚â• <span class="mono">${fmt(Math.round(r.lowVol.threshold))}</span>/h (1√ó p/h).</div>` : '';

    return `<div class="expand" aria-hidden="true">
      <div class="expand-inner">
        <h4>${esc(r.name)}</h4>
        <div class="meta">${head}</div>
        ${speed}
        ${vol}
        <div class="hint" style="margin-bottom:6px">
          Component costs use <span class="kbd">${basisLabel(els.buyBasis.value)}</span> for buy basis. Potion components are valued at <b>(4) per-dose</b>.
          Goggles apply ‚àí10% expected quantity to secondaries (except Crystal dust). Crystal dust can be valued from ECTS depending on the selector. If enabled, the expected gp for Alchemist‚Äôs-amulet charges is included.
        </div>
        <table>
          <thead>
            <tr><th>Component</th><th class="num">Qty</th><th class="num">Eff. Qty</th><th class="num">Unit gp</th><th class="num">Total gp</th><th>Notes</th></tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    </div>`;
  }

  function toggleDetail(tr, det){
    const box = det.querySelector('.expand');
    const isOpen = det.classList.contains('open');
    if(isOpen){
      const h = box.scrollHeight;
      box.style.maxHeight = h + 'px';
      box.offsetHeight;
      box.style.maxHeight = '0px';
      tr.setAttribute('aria-expanded','false');
      box.setAttribute('aria-hidden','true');
      det.classList.remove('open');
    } else {
      box.style.maxHeight = '0px';
      box.offsetHeight;
      box.style.maxHeight = box.scrollHeight + 'px';
      const onEnd = ()=>{ box.style.maxHeight = 'none'; box.removeEventListener('transitionend', onEnd); };
      box.addEventListener('transitionend', onEnd);
      tr.setAttribute('aria-expanded','true');
      box.setAttribute('aria-hidden','false');
      det.classList.add('open');
    }
  }

  function renderRows(rows){
    const tb=els.tbody;
    tb.innerHTML='';
    const COLS = document.querySelectorAll('#tbl thead th').length;

    for(const r of rows){
      const tr=document.createElement('tr');
      tr.className='row';
      tr.dataset.key=r.name;
      tr.tabIndex=0;
      tr.setAttribute('role','button');
      tr.setAttribute('aria-expanded','false');

      const cls=r.profit==null? '' : (r.profit>=0? 'ok':'bad');
      const slowIco = r.slow ? `<abbr class="slow" title="${esc(r.slow.title)}">üêå</abbr>` : '';
      const lowIco = (r.lowVol && r.lowVol.warn) ? `<abbr class="lowvol" title="${esc(r.lowVol.title)}">üìâ</abbr>` : '';

      tr.innerHTML= `
        <td><div class="namecell"><span class="chev">‚ñ∂</span> ${esc(r.name)} ${slowIco} ${lowIco}</div></td>
        <td class="num">${fmt(r.xp)}</td>
        <td class="num">${fmt(r.baseDoses)}</td>
        <td class="num">${fmt(r.expDoses.toFixed(2))}</td>
        <td class="num mono">${fmt(Math.round(r.cost??0))}</td>
        <td class="num mono">${fmt(Math.round(r.revenue??0))}</td>
        <td class="num mono ${cls}">${r.profit==null? '‚Äî' : fmt(Math.round(r.profit))}</td>
        <td class="num mono ${cls}">${r.gphr==null? '‚Äî' : fmt(Math.round(r.gphr))}</td>
        <td class="num mono ${cls}">${pct(r.profitPct)}</td>
        <td class="num mono ${cls}">${r.gpxp==null? '‚Äî' : ( (r.gpxp>=0? '+':'') + r.gpxp.toFixed(3) )}</td>
        <td class="hint notes">${esc(r.note)}</td>`;

      const det=document.createElement('tr');
      det.className='detail';
      const td=document.createElement('td');
      td.colSpan=COLS;
      td.innerHTML=rowDetailHTML(r);
      det.appendChild(td);

      const activate = (ev)=>{
        if(ev.type==='click' && (ev.target.closest('a,button,select,input,label'))) return;
        if(ev.type==='keydown' && !['Enter',' '].includes(ev.key)) return;
        ev.preventDefault();
        toggleDetail(tr, det);
      };
      tr.addEventListener('click', activate);
      tr.addEventListener('keydown', activate);

      tb.appendChild(tr);
      tb.appendChild(det);
    }
  }

  function toCsv(rows){
    const hdr=['Potion','XP','Base doses','Expected doses','Buy cost','Sell value','GP per potion','GP per hour','Profit %','GP / XP','Notes'];
    const body=rows.map(r=>[r.name,r.xp,r.baseDoses,r.expDoses.toFixed(2),Math.round(r.cost??0),Math.round(r.revenue??0),Math.round(r.profit??0),Math.round(r.gphr??0),r.profitPct==null?'':r.profitPct.toFixed(2),r.gpxp==null?'':r.gpxp.toFixed(5),r.note].map(v=>`"${String(v).replaceAll('"','""')}"`).join(','));
    return [hdr.join(','),...body].join('\n');
  }

  function sortBy(rows,key,asc=true){
    const a=[...rows];
    a.sort((x,y)=>{
      const vx=x[key], vy=y[key];
      if(vx==null&&vy==null) return 0;
      if(vx==null) return 1;
      if(vy==null) return -1;
      return (asc?1:-1)*(vx>vy?1:vx<vy?-1:0)
    });
    return a;
  }

  function updateSortIndicators(){
    const heads = document.querySelectorAll('#tbl thead th');
    heads.forEach(th=>{
      const k = th.dataset.k;
      if(!k) return;
      th.classList.toggle('sorted', k===sortKey);
      th.classList.toggle('asc', k===sortKey && sortAsc);
      th.classList.toggle('desc', k===sortKey && !sortAsc);
      th.setAttribute('aria-sort', k===sortKey ? (sortAsc?'ascending':'descending') : 'none');
      const ico = th.querySelector('.ico');
      if(ico) ico.textContent = k===sortKey ? (sortAsc ? '‚ñ≤' : '‚ñº') : '‚Üï';
    });
  }

  // --- HARD-CODED RECIPES (product4 only) ---
const RECIPES=[
{name:'Attack potion', baseDoses:3, xp:25, product4:'Attack potion(4)', components:['Guam potion (unf)','Eye of newt']},
{name:'Prayer potion', baseDoses:3, xp:87.5, product4:'Prayer potion(4)', components:['Ranarr potion (unf)','Snape grass']},
{name:'Stamina(1)', baseDoses:1, xp:25.5, product4:'Stamina potion(4)', components:[{name:'Super energy(1)'},{name:'Amylase crystal', qty:1}]},
{name:'Stamina(2)', baseDoses:2, xp:51.0, product4:'Stamina potion(4)', components:[{name:'Super energy(2)'},{name:'Amylase crystal', qty:2}]},
{name:'Stamina(3)', baseDoses:3, xp:76.5, product4:'Stamina potion(4)', components:[{name:'Super energy(3)'},{name:'Amylase crystal', qty:3}]},
{name:'Stamina(4)', baseDoses:4, xp:102.0, product4:'Stamina potion(4)', components:[{name:'Super energy(4)'},{name:'Amylase crystal', qty:4}]},
{name:'Anti-venom (1)', baseDoses:1, xp:30, product4:'Anti-venom(4)', components:[{name:"Antidote++(1)"},{name:"Zulrah's scales", qty:5}]},
{name:'Anti-venom (2)', baseDoses:2, xp:60, product4:'Anti-venom(4)', components:[{name:"Antidote++(2)"},{name:"Zulrah's scales", qty:10}]},
{name:'Anti-venom (3)', baseDoses:3, xp:90, product4:'Anti-venom(4)', components:[{name:"Antidote++(3)"},{name:"Zulrah's scales", qty:15}]},
{name:'Anti-venom (4)', baseDoses:4, xp:120, product4:'Anti-venom(4)', components:[{name:"Antidote++(4)"},{name:"Zulrah's scales", qty:20}]},
{name:'Anti-venom+ (4)', baseDoses:4, xp:125, product4:'Anti-venom+(4)', components:[{name:'Anti-venom(4)'},{name:'Torstol', qty:1}]},
{name:'Extended antifire (1)', baseDoses:1, xp:27.5, product4:'Extended antifire(4)', components:[{name:'Antifire potion(1)'},{name:'Lava scale shard', qty:1}]},
{name:'Extended antifire (2)', baseDoses:2, xp:55, product4:'Extended antifire(4)', components:[{name:'Antifire potion(2)'},{name:'Lava scale shard', qty:2}]},
{name:'Extended antifire (3)', baseDoses:3, xp:82.5, product4:'Extended antifire(4)', components:[{name:'Antifire potion(3)'},{name:'Lava scale shard', qty:3}]},
{name:'Extended antifire (4)', baseDoses:4, xp:110, product4:'Extended antifire(4)', components:[{name:'Antifire potion(4)'},{name:'Lava scale shard', qty:4}]},
{name:'Super antifire (4)', baseDoses:4, xp:130, product4:'Super antifire potion(4)', components:[{name:'Antifire potion(4)'},{name:'Crushed superior dragon bones', qty:1}]},
{name:'Extended super antifire (1)', baseDoses:1, xp:40, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(1)'},{name:'Lava scale shard', qty:1}]},
{name:'Extended super antifire (2)', baseDoses:2, xp:80, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(2)'},{name:'Lava scale shard', qty:2}]},
{name:'Extended super antifire (3)', baseDoses:3, xp:120, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(3)'},{name:'Lava scale shard', qty:3}]},
{name:'Extended super antifire (4)', baseDoses:4, xp:160, product4:'Extended super antifire(4)', components:[{name:'Super antifire potion(4)'},{name:'Lava scale shard', qty:4}]},
{name:'Divine super combat (1)', baseDoses:1, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine super combat (2)', baseDoses:2, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine super combat (3)', baseDoses:3, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine super combat (4)', baseDoses:4, xp:0, product4:'Divine super combat potion(4)', components:[{name:'Super combat potion(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine super attack (1)', baseDoses:1, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine super attack (2)', baseDoses:2, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine super attack (3)', baseDoses:3, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine super attack (4)', baseDoses:4, xp:0, product4:'Divine super attack potion(4)', components:[{name:'Super attack(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine super strength (1)', baseDoses:1, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine super strength (2)', baseDoses:2, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine super strength (3)', baseDoses:3, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine super strength (4)', baseDoses:4, xp:0, product4:'Divine super strength potion(4)', components:[{name:'Super strength(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine super defence (1)', baseDoses:1, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine super defence (2)', baseDoses:2, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine super defence (3)', baseDoses:3, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine super defence (4)', baseDoses:4, xp:0, product4:'Divine super defence potion(4)', components:[{name:'Super defence(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine ranging (1)', baseDoses:1, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine ranging (2)', baseDoses:2, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine ranging (3)', baseDoses:3, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine ranging (4)', baseDoses:4, xp:0, product4:'Divine ranging potion(4)', components:[{name:'Ranging potion(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine magic (1)', baseDoses:1, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine magic (2)', baseDoses:2, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine magic (3)', baseDoses:3, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine magic (4)', baseDoses:4, xp:0, product4:'Divine magic potion(4)', components:[{name:'Magic potion(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine bastion (1)', baseDoses:1, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine bastion (2)', baseDoses:2, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine bastion (3)', baseDoses:3, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine bastion (4)', baseDoses:4, xp:0, product4:'Divine bastion potion(4)', components:[{name:'Bastion potion(4)'},{name:'Crystal dust', qty:4}]},
{name:'Divine battlemage (1)', baseDoses:1, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(1)'},{name:'Crystal dust', qty:1}]},
{name:'Divine battlemage (2)', baseDoses:2, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(2)'},{name:'Crystal dust', qty:2}]},
{name:'Divine battlemage (3)', baseDoses:3, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(3)'},{name:'Crystal dust', qty:3}]},
{name:'Divine battlemage (4)', baseDoses:4, xp:0, product4:'Divine battlemage potion(4)', components:[{name:'Battlemage potion(4)'},{name:'Crystal dust', qty:4}]},
{name:'Extended anti-venom+ (1)', baseDoses:1, xp:20, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(1)'},{name:'Araxyte venom sack', qty:1}]},
{name:'Extended anti-venom+ (2)', baseDoses:2, xp:40, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(2)'},{name:'Araxyte venom sack', qty:2}]},
{name:'Extended anti-venom+ (3)', baseDoses:3, xp:60, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(3)'},{name:'Araxyte venom sack', qty:3}]},
{name:'Extended anti-venom+ (4)', baseDoses:4, xp:80, product4:'Extended anti-venom+(4)', components:[{name:'Anti-venom+(4)'},{name:'Araxyte venom sack', qty:4}]},
{name:'Bastion potion', baseDoses:3, xp:155, product4:'Bastion potion(4)', components:[{name:'Cadantine blood potion (unf)'},{name:'Wine of zamorak'}]},
{name:'Battlemage potion', baseDoses:3, xp:155, product4:'Battlemage potion(4)', components:[{name:'Cadantine blood potion (unf)'},{name:'Potato cactus'}]},
{name:'Compost potion', baseDoses:3, xp:60, product4:'Compost potion(4)', components:[{name:'Harralander potion (unf)'},{name:'Volcanic ash'}]},
{name:'Serum 207', baseDoses:3, xp:50, product4:'Serum 207(4)', components:[{name:'Tarromin potion (unf)'},{name:'Ashes'}]},
{name:'Super combat potion (4)', baseDoses:4, xp:150, product4:'Super combat potion(4)', components:[{name:'Super attack(4)'},{name:'Super strength(4)'},{name:'Super defence(4)'},{name:'Torstol', qty:1}]},

// ===== Core bases & prerequisites =====
{name:'Antifire potion', baseDoses:3, xp:157.5, product4:'Antifire potion(4)', components:['Lantadyme potion (unf)','Dragon scale dust']},
{name:'Super energy', baseDoses:3, xp:117.5, product4:'Super energy(4)', components:['Avantoe potion (unf)','Mort myre fungus']},
{name:'Super attack', baseDoses:3, xp:100, product4:'Super attack(4)', components:['Irit potion (unf)','Eye of newt']},
{name:'Super strength', baseDoses:3, xp:125, product4:'Super strength(4)', components:['Kwuarm potion (unf)','Limpwurt root']},
{name:'Super defence', baseDoses:3, xp:150, product4:'Super defence(4)', components:['Cadantine potion (unf)','White berries']},
{name:'Ranging potion', baseDoses:3, xp:162.5, product4:'Ranging potion(4)', components:['Dwarf weed potion (unf)','Wine of zamorak']},
{name:'Magic potion', baseDoses:3, xp:172.5, product4:'Magic potion(4)', components:['Lantadyme potion (unf)','Potato cactus']},
{name:'Antidote+ (4)', baseDoses:4, xp:155, product4:'Antidote+(4)', components:[{name:'Coconut Milk'},{name:'Toadflax'},{name:'Yew roots', qty:1}]},
{name:'Antidote++ (4)', baseDoses:4, xp:177.5, product4:'Antidote++(4)', components:[{name:'Coconut Milk'},{name:'Irit Leaf'},{name:'Magic roots', qty:1}]},

{name:'Antipoison', baseDoses:3, xp:37.5, product4:'Antipoison(4)', components:['Marrentill potion (unf)','Unicorn horn dust']},
{name:'Strength potion', baseDoses:3, xp:50, product4:'Strength potion(4)', components:['Tarromin potion (unf)','Limpwurt root']},
{name:'Restore potion', baseDoses:3, xp:62.5, product4:'Restore potion(4)', components:['Harralander potion (unf)',"Red spiders' eggs"]},
{name:'Energy potion', baseDoses:3, xp:67.5, product4:'Energy potion(4)', components:['Harralander potion (unf)','Chocolate dust']},
{name:'Defence potion', baseDoses:3, xp:75, product4:'Defence potion(4)', components:['Ranarr potion (unf)','White berries']},
{name:'Agility potion', baseDoses:3, xp:80, product4:'Agility potion(4)', components:['Toadflax potion (unf)',"Toad's legs"]},
{name:'Fishing potion', baseDoses:3, xp:112.5, product4:'Fishing potion(4)', components:['Avantoe potion (unf)','Snape grass']},
{name:'Hunter potion', baseDoses:3, xp:120, product4:'Hunter potion(4)', components:['Avantoe potion (unf)','Kebbit teeth dust']},

// Supers & common late-game bases
{name:'Superantipoison', baseDoses:3, xp:106.3, product4:'Superantipoison(4)', components:['Irit potion (unf)','Unicorn horn dust']},
{name:'Super restore', baseDoses:3, xp:142.5, product4:'Super restore(4)', components:['Snapdragon potion (unf)',"Red spiders' eggs"]},
{name:'Antifire potion', baseDoses:3, xp:157.5, product4:'Antifire potion(4)', components:['Lantadyme potion (unf)','Dragon scale dust']},
// Brews & combo
{name:'Saradomin brew', baseDoses:3, xp:180, product4:'Saradomin brew(4)', components:['Toadflax potion (unf)','Crushed nest']},
{name:'Zamorak brew', baseDoses:3, xp:175, product4:'Zamorak brew(4)', components:['Torstol potion (unf)','Jangerberries']},
{name:'Combat potion', baseDoses:3, xp:84, product4:'Combat potion(4)', components:['Harralander potion (unf)','Goat horn dust']}
];

  let rows=[];
  let sortKey='profit', sortAsc=false;

  async function compute(){
    if(!MAP||!PRICE) return;
    const base = RECIPES.map(computeRow);
    const filtered = (els.hideLowVol && els.hideLowVol.checked)
      ? base.filter(r => !(r.lowVol && r.lowVol.warn))
      : base;
    rows = sortBy(filtered, sortKey, sortAsc);
    renderRows(rows);
    updateSortIndicators();
  }

  ['change','input'].forEach(evt=>{
    els.buyBasis.addEventListener(evt, compute);
    els.sellBasis.addEventListener(evt, compute);
    els.tax.addEventListener(evt, compute);
    els.dustMode.addEventListener(evt, compute);
    els.pph.addEventListener(evt, compute);
    if(els.chemCost) els.chemCost.addEventListener(evt, compute); // UPDATED: only chemCost
  });
  if(els.hideLowVol){ els.hideLowVol.addEventListener('change', compute); }

  const thead=document.querySelector('#tbl thead');
  thead.addEventListener('click', (e)=>{
    const th=e.target.closest('th'); if(!th) return;
    const k=th.dataset.k; if(!k) return;
    if(sortKey===k){ sortAsc=!sortAsc; } else { sortKey=k; sortAsc=true; }
    rows=sortBy(rows,sortKey,sortAsc);
    renderRows(rows);
    updateSortIndicators();
  });

  els.copyCsv.addEventListener('click', ()=>{
    try{ navigator.clipboard.writeText(toCsv(rows)); alert('CSV copied.'); }
    catch(e){ alert('Copy failed: '+e.message);} 
  });

  els.downloadCsv.addEventListener('click', ()=>{
    const blob=new Blob([toCsv(rows)],{type:'text/csv'});
    const url=URL.createObjectURL(blob);
    const a=Object.assign(document.createElement('a'),{href:url,download:'herblore-live.csv'});
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // Manual refresh button
  if(els.refreshNow){
    els.refreshNow.addEventListener('click', async ()=>{
      setStatus('Refreshing‚Ä¶', true);
      els.refreshNow.disabled = true;
      try{
        await fetchLatest();
        await fetchVolumes(); // refresh volumes too
        await compute();
      } catch(e){
        setStatus('Refresh error: '+e.message);
      } finally{
        els.refreshNow.disabled = false;
      }
    });
  }

  // Auto-refresh timer
  let timer=null;
  function setTimer(){
    if(timer) clearInterval(timer);
    const mins=Math.max(0, Number(els.refreshMins.value||0));
    if(mins>0){
      timer=setInterval(async()=>{
        try{
          await fetchLatest();
          await compute();
          // Volume averages don't change rapidly; skip to reduce API load.
        }catch(e){ setStatus('Refresh error: '+e.message); }
      }, mins*60*1000);
    }
  }
  els.refreshMins.addEventListener('change', setTimer);

  // Boot
  (async function boot(){
    try{
      await fetchMapping();
      await fetchLatest();
      await fetchVolumes();
      await compute();
      setTimer();
    } catch(e){
      console.error(e);
      setStatus('Error: '+e.message);
    }
  })();
})();
</script>
</body>
</html>

